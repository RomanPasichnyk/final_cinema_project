<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Cinema</title>
    <link href="public/css/bootstrap.min.css" rel="stylesheet">
    <link href="public/css/navbar_footer.css" rel="stylesheet">
    <link href="public/css/films.css" rel="stylesheet">
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <a href="#" class="navbar-brand">Cinema</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggleExternalContent" aria-controls="navbarToggleExternalContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarToggleExternalContent">
            <ul class="navbar-nav mr-auto" id="head">
                <li class="nav-item">
                    <a href="films.html" class="nav-link">Films</a>
                </li>
                <li class="nav-item">
                    <a href="sessions.html" class="nav-link">Sessions</a>
                </li>
                <li class="nav-item">
                    <a href="contactUs.html" class="nav-link">Contact Us</a>
                </li>
            </ul>
            <form class="form-inline my-2 my-lg-0">
                <ul class="navbar-nav my-2 my-sm-0">
                   <li class="nav-item" id="profileBtn">
                        
                        
                    </li>
                    <li class="nav-item">
                        <a href="signIn.html" class="nav-link" id="logoutBtn">Log Out</a>
                    </li>
                    
                </ul>
            </form>

        </div>
    </nav>


    <section>



        <div class="container bootstrap snippet">
            <div class="row">
                <div class="col-sm-3">
                    <!--left col-->


                    <div class="text-center">
                        <img src="http://ssl.gstatic.com/accounts/ui/avatar_2x.png" class="avatar img-circle img-thumbnail" alt="avatar">

                        <h6>Upload a different photo...</h6>
                        <input type="file" class="text-center center-block file-upload" id="image">
                        <div>
                        <br>
                        <button class="btn btn-lg btn-success" type="button" id="btnSaveImage"><i class="glyphicon glyphicon-ok-sign"></i>Save new image</button>
                        </div>
                    </div><br>







                    <ul class="list-group">
                        <li class="list-group-item text-muted">Activity <i class="fa fa-dashboard fa-1x"></i></li>
                        <li class="list-group-item text-right"><span class="pull-left"><strong>Comments</strong></span> 3</li>
                    </ul>

                </div>
                <!--/col-3-->
                <div class="col-sm-9">


                    <form class="form" action="##" method="post" id="updateUserForm">
                        <label id="error" style="color:red"></label>
                        <div class="form-group">
                            <label for="email">
                                <h5>Email</h5>
                            </label>


                            <input type="text" class="form-control" name="email" id="email" placeholder="Your Email" title="enter your email">

                        </div>
                        <div class="form-group">

                            <label for="name">
                                <h5>Name</h5>
                            </label>
                            <input type="text" class="form-control" name="name" id="name" placeholder="Your Name" title="enter your name">

                        </div>

                        <div class="form-group">

                            <div class="col-xs-6">
                                <label for="phone">
                                    <h5>Phone Number</h5>
                                </label>
                                <input type="text" class="form-control" name="phone" id="phone" placeholder="Your Phone Number" title="enter your phone number">
                            </div>
                        </div>

                        <div class="form-group">

                            <div class="col-xs-6">
                                <label for="age">
                                    <h5>Age</h5>
                                </label>
                                <input type="text" class="form-control" name="age" id="age" placeholder="Your Age" title="enter your age">
                            </div>
                        </div>


                        <div class="form-group">
                            <div class="col-xs-6">
                                <div class="row mx-auto">
                                    <label>
                                        <h5>Birth Date</h5>
                                    </label>

                                    <div class="col-xs-5 col-md-5">
                                        <select class="form-control" id="month">
                                            <option value=01>January</option>
                                            <option value=02>February</option>
                                            <option value=03>March</option>
                                            <option value=04>April</option>
                                            <option value=05>May</option>
                                            <option value=06>June</option>
                                            <option value=07>July</option>
                                            <option value=08>August</option>
                                            <option value=09>September</option>
                                            <option value=10>October</option>
                                            <option value=11>November</option>
                                            <option value=12>December</option>
                                        </select>
                                    </div>
                                    <div class="col-xs-5 col-md-5">
                                        <select class="form-control" id="day">
                                            <option value=01>01</option>
                                            <option value=02>02</option>
                                            <option value=03>03</option>
                                            <option value=04>04</option>
                                            <option value=05>05</option>
                                            <option value=06>06</option>
                                            <option value=07>07</option>
                                            <option value=08>08</option>
                                            <option value=09>09</option>
                                            <option value=10>10</option>
                                            <option value=11>11</option>
                                            <option value=12>12</option>
                                            <option value=13>13</option>
                                            <option value=14>14</option>
                                            <option value=15>15</option>
                                            <option value=16>16</option>
                                            <option value=17>17</option>
                                            <option value=18>18</option>
                                            <option value=19>19</option>
                                            <option value=20>20</option>
                                            <option value=21>21</option>
                                            <option value=22>22</option>
                                            <option value=23>23</option>
                                            <option value=24>24</option>
                                            <option value=25>25</option>
                                            <option value=26>26</option>
                                            <option value=27>27</option>
                                            <option value=28>28</option>
                                            <option value=29>29</option>
                                            <option value=30>30</option>
                                            <option value=31>31</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">

                            <div class="col-xs-6">
                                <label for="gender">
                                    <h5>Gender</h5>
                                </label>

                                <select class="form-control" id="gender">
                                    <option value=00>MALE</option>
                                    <option value=01>FEMALE</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-xs-6">
                                <div class="col-xs-6">
                                    <label for="userFavoriteGenre">
                                        <h5>Favority Genre</h5>
                                    </label>
                                    <select class="form-control" id="userFavoriteGenre">
                                        <option value="COMEDY">Comedy</option>
                                        <option value="HORROR">Horror</option>
                                        <option value="ROMANCE">Romance</option>
                                        <option value="ACTION">Action</option>
                                        <option value="THRILLER">Thriller</option>
                                        <option value="DRAMA">Drama</option>
                                        <option value="MYSTERY">Mystery</option>
                                        <option value="CRIME">Crime</option>
                                        <option value="ANIMATION">Animation</option>
                                        <option value="ADVENTURE">Adventure</option>
                                        <option value="FANTASY">Fantasy</option>
                                        <option value="COMEDYROMANCE">Comedy-Romance</option>
                                        <option value="ACTIONCOMEDY">Action-Comedy</option>
                                        <option value="SUPERHERO">Superhero</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">

                            <div class="col-xs-6">
                                <label for="newPassword">
                                    <h5>New Password</h5>
                                </label>
                                <input type="password" class="form-control" name="newPassword" id="newPassword" placeholder="Your New Password" title="enter your new password">
                            </div>
                        </div>

                        <div class="form-group">

                            <div class="col-xs-6">
                                <label for="password">
                                    <h5>Password for confirm</h5>
                                </label>
                                <input type="password" class="form-control" name="password" id="password" placeholder="Your Password" title="enter your password">
                            </div>
                        </div>



                        <div class="form-group">
                            <div class="col-xs-12">
                                <br>
                                <button class="btn btn-lg btn-success" type="submit"><i class="glyphicon glyphicon-ok-sign"></i>Save</button>
                                <button class="btn btn-lg" type="reset"><i class="glyphicon glyphicon-repeat"></i>Reset</button>
                            </div>
                        </div>



                    </form>

                    <hr>

                </div>
                <!--/col-9-->
            </div>
            <!--/row-->
        </div>





    </section>


    <!--footer starts from here-->
    <footer class="footer">
        <div class="container">
            <ul class="foote_bottom_ul_amrc">
                <br>
                <li><a href="films.html">Home</a></li>
            </ul>
            <!--foote_bottom_ul_amrc ends here-->
            <p class="text-center">Copyright @2019 | Designed by <a href="#">Roman Pasichnyk</a></p>

            <ul class="social_footer_ul">
                <li><a href="http://facebook.com"><i class="fa fa-facebook-f"></i></a></li>
                <li><a href="http://twitter.com"><i class="fa fa-twitter"></i></a></li>
                <li><a href="http://linkedin.com"><i class="fa fa-linkedin"></i></a></li>
                <li><a href="http://instagram.com"><i class="fa fa-instagram"></i></a></li>
            </ul>
        </div>
    </footer>


    <script src=public/js/jquery.min.js> </script> <script src="public/js/bootstrap.min.js"></script>

    <script>
        let serverURL = 'http://localhost:8080/';
        $(document).ready(function() {
            let token = window.localStorage.getItem('auth_token');
            let userEmail = parseJwt(token).sub;
            if (token) {
                let role = parseJwt(token).auth;
                if (role === 'ROLE_ADMIN') {
                    $('#head').append(
                        `
                        <li class="nav-item active">
                            <a href="editFilms.html" class="nav-link">AdminPanel</a>
                        </li>
                        `
                    )
                };
                $.ajaxSetup({
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                })

                $('#logoutBtn').on('click', function(e) {
                    window.localStorage.removeItem('auth_token');
                    window.location.reload();
                });

                getUserByEmail(userEmail);
                getUserByEmailForProfile(userEmail);

                var readURL = function(input) {
                    if (input.files && input.files[0]) {
                        var reader = new FileReader();

                        reader.onload = function(e) {
                            $('.avatar').attr('src', e.target.result);
                        }

                        reader.readAsDataURL(input.files[0]);
                    }
                }


                $(".file-upload").on('change', function() {
                    readURL(this);
                });

                $("#updateUserForm").submit(function(e) {
                    e.preventDefault();

                    updateUser(userEmail);
                    
                });
                
                $('#btnSaveImage').on('click', function(e) {
                    findByEmail(userEmail);
                });



            } else {
                window.location.href = "signIn.html";
            }
        });
        
        function getUserByEmailForProfile(userEmail) {
            
            $.ajax({
                url: serverURL + "users/find?email=" + userEmail,
                method: "GET",
                dataType: "json",
                contentType: "application/json",
                success: function(response) {
                    $('#profileBtn').append(
                    `
                        <a href="profile.html?id=${response.id}" class="nav-link" id="profileBtn">Profile</a>
                    `)

                }
            })
        }

        function getUserByEmail(userEmail) {
            var arr = ["COMEDY", "HORROR", "ROMANCE", "ACTION", "THRILLER", "DRAMA", "MYSTERY", "CRIME", "ANIMATION", "ADVENTURE", "FANTASY", "COMEDYROMANCE", "ACTIONCOMEDY", "SUPERHERO"];
            $.ajax({
                url: serverURL + "users/find?email=" + userEmail,
                method: "GET",
                dataType: "json",
                contentType: "application/json",
                success: function(response) {
                    document.getElementById("email").value = response.email;
                    document.getElementById("name").value = response.name;
                    document.getElementById("phone").value = response.phoneNumber;
                    document.getElementById("age").value = response.age;
                    document.getElementById("month").options[response.birthDate[1] - 1].setAttribute("selected", "selected");
                    document.getElementById("day").options[response.birthDate[2] - 1].setAttribute("selected", "selected");
                    for (i = 0; i < arr.length; i++) {
                        if (response.favoriteGenre == arr[i]) {
                            document.getElementById("userFavoriteGenre").options[i].setAttribute("selected", "selected");
                        }
                    }
                    if (response.gender == "FEMALE") {
                        document.getElementById("gender").options[01].setAttribute("selected", "selected");
                    }

                }
            })
        }

        function updateUser(oldEmail) {
            let userEmail = $("#email").val();
            let userName = $("#name").val();
            let userAge = $("#age").val();
            let userPhoneNumber = $("#phone").val();
            let userBirthDay = ["2019" - userAge, $("#month").val(), $("#day").val()];
            let userGender = $("#gender").val();
            let userFavoriteGenre = $("#userFavoriteGenre").val();
            let newPassword = $("#newPassword").val();
            let confirmPassword = $("#password").val();

            let user = {
                email: userEmail,
                password: newPassword,
                confirmPassword: confirmPassword,
                name: userName,
                age: userAge,
                phoneNumber: userPhoneNumber,
                favoriteGenre: userFavoriteGenre,
                birthDate: "" + userBirthDay[0] + "-" + userBirthDay[1] + "-" + userBirthDay[2],
                gender: userGender
            };
            console.log(user);

            $.ajax({
                url: serverURL + "users/update?email=" + oldEmail,
                method: "POST",
                dataType: "json",
                contentType: "application/json",
                data: JSON.stringify(user),
                complete: function(data) {
                    if (data.status == 201) {
                        window.location.href = "profile.html?id=1";
                    } else {
                        $("#error").empty();
                        $('#error').append(
                            `
                            ${data.responseJSON.message}
                        `
                        )
                        console.log(data);
                        console.log(data.responseJSON.message);
                    }
                }
            })
        }

        function uploadFile(userId) {
            let formData = new FormData();
            formData.append('file', $('#image')[0].files[0]);
            console.log($('#image')[0].files[0].name);
            $.ajax({
                url: serverURL + 'users/image/' + userId,
                method: 'POST',
                contentType: false,
                processData: false,
                data: formData,
                complete: function(res) {
                    alert("Image added");
                }
            })

        }

        function findByEmail(userEmail) {
            $.ajax({
                url: serverURL + "users/find?email=" + userEmail,
                method: 'GET',
                dataType: "json",
                contentType: "application/json",
                success: function(res) {
                    uploadFile(res.id);
                    console.log(res);
                }
            })
        }




        function parseJwt(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace('-', '+').replace('_', '/');
            return JSON.parse(window.atob(base64));
        }

    </script>

</body>

</html>
